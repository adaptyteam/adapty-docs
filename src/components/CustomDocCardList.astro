---
import { getCollection } from 'astro:content';
import fs from 'node:fs/promises';
import path from 'node:path';

interface Props {
  ids?: string[];
}

const { ids } = Astro.props;
const { slug: currentSlug } = Astro.params;

// 1. Fetch all docs for descriptions
const allDocs = await getCollection('docs');

// 2. Fetch all sidebars to resolve labels
const sidebarDir = path.resolve('./src/data/sidebars');
const sidebarFiles = (await fs.readdir(sidebarDir)).filter(f => f.endsWith('.json'));

const allSidebars = await Promise.all(
  sidebarFiles.map(async (file) => {
    const content = await fs.readFile(path.join(sidebarDir, file), 'utf-8');
    return JSON.parse(content);
  })
);

// Helper to find items in sidebar
function findInSidebar(items, targetId) {
  for (const item of items) {
    const id = item.id || (item.link && item.link.id);
    if (id === targetId) return item;
    if (item.items) {
      const found = findInSidebar(item.items, targetId);
      if (found) return found;
    }
  }
  return null;
}

// Helper to get labels for a list of items/ids
function resolveCardData(targetIds) {
  return targetIds.map(targetId => {
    // Find label in any sidebar
    let label = targetId;
    for (const sidebar of allSidebars) {
      const found = findInSidebar(sidebar, targetId);
      if (found) {
        label = found.label;
        break;
      }
    }

    // Find description in content collection
    const doc = allDocs.find(d => {
        const idWithoutExt = d.id.replace(/\.(md|mdx)$/, '');
        const basename = idWithoutExt.split('/').pop();
        return idWithoutExt === targetId || basename === targetId || d.id === targetId;
    });

    return {
      id: targetId,
      label,
      description: doc?.data.description || 'Learn more about this topic in our documentation.',
      href: `/${targetId}`
    };
  });
}

let cards = [];

if (ids && ids.length > 0) {
  cards = resolveCardData(ids);
} else {
  // Auto-detect children of current page
  let currentPageItem = null;
  for (const sidebar of allSidebars) {
    currentPageItem = findInSidebar(sidebar, currentSlug || 'what-is-adapty');
    if (currentPageItem && currentPageItem.items) break;
  }

  if (currentPageItem && currentPageItem.items) {
    const childIds = currentPageItem.items
      .map(item => item.id || (item.link && item.link.id))
      .filter(id => id !== undefined);
    cards = resolveCardData(childIds);
  }
}
---

<div class="not-prose grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 my-8">
  {cards.map((card) => (
    <a 
      href={card.href}
      class="doc-card"
    >
      <div class="flex items-center justify-between mb-0.5">
        <h3 class="doc-card-title">
          {card.label}
        </h3>
        <svg class="doc-card-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </div>
      <p class="doc-card-description">
        {card.description}
      </p>
    </a>
  ))}
</div>

<style>
  .doc-card {
    display: flex;
    flex-direction: column;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid var(--border-primary);
    background: var(--bg-primary);
    box-shadow: var(--shadow-sm);
    transition: all 0.3s;
    text-decoration: none;
  }
  
  .doc-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--border-secondary);
    background: var(--bg-hover);
  }
  
  .doc-card-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    line-height: 1.3;
  }
  
  .doc-card-description {
    font-size: 11px;
    line-height: 1.6;
    color: var(--text-secondary);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .doc-card-arrow {
    width: 0.75rem;
    height: 0.75rem;
    color: var(--text-tertiary);
    flex-shrink: 0;
    margin-left: 0.5rem;
    transition: all 0.3s;
  }
  
  .doc-card:hover .doc-card-arrow {
    color: var(--text-secondary);
    transform: translateX(0.125rem);
  }
  
  /* Ensure proper contrast in dark mode */
  :root.dark .doc-card-title,
  html.dark .doc-card-title,
  .dark .doc-card-title {
    color: #f1f5f9 !important;
  }
  
  :root.dark .doc-card-description,
  html.dark .doc-card-description,
  .dark .doc-card-description {
    color: #cbd5e1 !important;
  }
</style>
