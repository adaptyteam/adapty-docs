---
interface Props {
  tooltip: string;
}

const { tooltip } = Astro.props;
---

<span class="tooltip-container relative group" data-tooltip-wrapper>
  <span class="tooltip-trigger cursor-help relative text-[var(--accent-primary)] font-semibold transition-all duration-200 hover:text-[var(--accent-hover)] decoration-dotted underline underline-offset-4 decoration-[var(--accent-primary)]/30 hover:decoration-[var(--accent-primary)]/80">
    {tooltip}
  </span>
  
  <span class="tooltip-popup absolute bottom-[calc(100%+8px)] left-1/2 -translate-x-1/2 translate-y-2 w-max max-w-[320px] 
              opacity-0 invisible transition-all duration-200 ease-out z-[9999] pointer-events-none 
              group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 group-hover:pointer-events-auto
              group-[.force-closed]:opacity-0 group-[.force-closed]:invisible group-[.force-closed]:pointer-events-none
              before:absolute before:-bottom-3 before:left-0 before:w-full before:h-4 before:content-['']">
    <span class="tooltip-content block relative bg-[var(--bg-primary)] border border-[var(--border-primary)] rounded-xl shadow-[var(--shadow-lg)] p-4 pr-10 text-sm text-[var(--text-secondary)] leading-relaxed min-w-[200px]">
      <button class="tooltip-close absolute top-2 right-2 p-1 text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors" aria-label="Close tooltip">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <span class="tooltip-inner block" data-astro-rerun>
        <slot />
      </span>
      <span class="tooltip-arrow absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-[var(--bg-primary)] after:content-[''] after:absolute after:top-[-7px] after:left-[-6px] after:border-l-[6px] after:border-l-transparent after:border-r-[6px] after:border-r-transparent after:border-t-[6px] after:border-t-[var(--border-primary)] after:-z-10"></span>
    </span>
  </span>
</span>

<script>
  function initTooltips() {
    const wrappers = document.querySelectorAll('[data-tooltip-wrapper]');
    
    wrappers.forEach(wrapper => {
      // Avoid double initialization
      if (wrapper.getAttribute('data-tooltip-initialized')) return;
      wrapper.setAttribute('data-tooltip-initialized', 'true');

      const closeBtn = wrapper.querySelector('.tooltip-close');

      if (!closeBtn) return;

      // Handle Close Button (Force Close)
      closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        wrapper.classList.add('force-closed');
      });

      // Reset state when mouse actually leaves the wrapper
      wrapper.addEventListener('mouseleave', () => {
        wrapper.classList.remove('force-closed');
      });
    });
  }

  // Initialize on page load and navigation
  initTooltips();
  document.addEventListener('astro:page-load', initTooltips);
</script>

<style>
  .tooltip-container {
    display: inline !important;
    vertical-align: baseline;
    line-height: inherit;
  }
  
  .tooltip-trigger {
    display: inline;
    line-height: 1.6;
    vertical-align: baseline;
  }
  
  .tooltip-popup {
    line-height: 1.6;
  }
  
  /* Custom typography for tooltip content */
  .tooltip-inner :global(strong) {
    color: var(--text-primary);
    font-weight: 600;
  }
  
  .tooltip-inner :global(a) {
    color: var(--accent-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
    font-weight: 500;
    transition: color 0.2s ease;
  }
  
  .tooltip-inner :global(a:hover) {
    color: var(--accent-hover);
  }

  .tooltip-inner :global(code) {
    font-size: 0.8125rem;
    padding: 0.125rem 0.375rem;
    background: var(--bg-hover);
    border: 1px solid var(--border-primary);
    border-radius: 0.375rem;
    color: var(--accent-primary);
    font-weight: 600;
  }
</style>
