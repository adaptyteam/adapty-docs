---
import Search from "./Search.astro";
import ThemeToggle from "./ThemeToggle.astro";

const links = [
  { label: "Documentation", href: "/", active: true },
  { label: "Blog", href: "https://adapty.io/blog", active: false },
  { label: "What's new", href: "https://adapty.io/whats-new", active: false },
  { label: "Glossary", href: "https://adapty.io/glossary", active: false },
  { label: "Pricing", href: "https://adapty.io/pricing", active: false },
];
---

<header class="header-main" transition:persist>
  <div class="w-full px-8 h-16 flex items-center justify-between">
    
    <div class="flex items-center gap-12">
        <!-- Logo -->
        <a href={import.meta.env.BASE_URL.replace(/\/+$/, '') || '/'} class="flex-shrink-0 block hover:opacity-80 transition-opacity">
          <img src={`${import.meta.env.BASE_URL}/logo.svg`.replace(/\/+/g, '/')} alt="Adapty" class="h-6 w-auto header-logo" />
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden lg:flex items-center gap-1 text-[14px] font-medium">
          <a href={import.meta.env.BASE_URL} class="nav-link">
            Documentation
          </a>
          
          <!-- Mobile SDK Dropdown -->
          <div class="relative dropdown-container">
            <button class="dropdown-trigger nav-link">
              Mobile SDK
              <svg class="dropdown-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            
            <!-- Dropdown Menu -->
            <div class="dropdown-menu">
               <div class="dropdown-content">
                {[
                  { label: "iOS", href: `${import.meta.env.BASE_URL}/ios-sdk-overview` },
                  { label: "Android", href: `${import.meta.env.BASE_URL}/android-sdk-overview` },
                  { label: "React Native", href: `${import.meta.env.BASE_URL}/react-native-sdk-overview` },
                  { label: "Flutter", href: `${import.meta.env.BASE_URL}/flutter-sdk-overview` },
                  { label: "Unity", href: `${import.meta.env.BASE_URL}/unity-sdk-overview` },
                  { label: "Kotlin Multiplatform", href: `${import.meta.env.BASE_URL}/kmp-sdk-overview` },
                  { label: "Capacitor", href: `${import.meta.env.BASE_URL}/capacitor-sdk-overview` }
                ].map(item => (
                  <a href={item.href.replace(/\/+/g, '/')} class="dropdown-item">
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
          </div>

          <a href={`${import.meta.env.BASE_URL}/getting-started-with-server-side-api`.replace(/\/+/g, '/')} class="nav-link">Server API</a>
          <a href="https://adapty.io/docs/whats-new" class="nav-link">
            What's new
          </a>
          <a href="https://adapty.featurebase.app" class="nav-link">Support Forum</a>
        </nav>
    </div>

    <!-- Search (Desktop) -->
    <div class="hidden lg:flex flex-1 max-w-sm mx-8">
      <Search />
    </div>

    <!-- Auth Buttons & Theme Toggle -->
    <div class="hidden lg:flex items-center gap-3">
      <ThemeToggle />
      <a 
        href="https://app.adapty.io/login" 
        class="nav-link"
      >
        Sign In
      </a>
      <a 
        href="https://app.adapty.io/registration" 
        class="px-5 py-2.5 text-sm font-semibold text-white bg-[#6720ff] hover:bg-[#5816e8] dark:bg-purple-600 dark:hover:bg-purple-500 rounded-xl transition-all shadow-[0_4px_15px_-2px_rgba(103,32,255,0.3)] hover:shadow-[0_8px_25px_-5px_rgba(103,32,255,0.4)] active:scale-[0.98]"
      >
        Sign Up for Free
      </a>
    </div>

    <!-- Mobile Search, Theme & Menu Buttons -->
    <div class="lg:hidden flex items-center gap-1">
      <button id="mobile-search-btn" class="p-2 text-[#443f49] dark:text-slate-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
      
      <button id="mobile-theme-toggle" type="button" class="mobile-theme-toggle p-2" aria-label="Toggle theme" title="Toggle theme">
        <!-- Sun icon (visible in dark mode) -->
        <svg class="sun-icon w-5 h-5" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        
        <!-- Moon icon (visible in light mode) -->
        <svg class="moon-icon w-5 h-5" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      
      <button id="mobile-menu-btn" class="p-2 text-[#443f49] dark:text-slate-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
  </div>
</header>

<style>
  .header-main {
    position: sticky;
    top: 0;
    z-index: 70;
    width: 100%;
    height: 64px;
    box-sizing: border-box;
    background-color: var(--bg-primary);
    backdrop-filter: blur(12px);
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
  }
  
  #mobile-menu-btn,
  #mobile-search-btn,
  #mobile-theme-toggle {
    position: relative;
    z-index: 71;
    cursor: pointer;
    transition: color 0.2s;
  }
  
  #mobile-search-btn:hover,
  #mobile-menu-btn:hover,
  #mobile-theme-toggle:hover {
    color: var(--text-primary);
  }
  
  /* Mobile theme toggle icons */
  #mobile-theme-toggle {
    border: none;
    background: transparent;
    color: var(--text-secondary);
  }
  
  #mobile-theme-toggle .sun-icon {
    display: none;
  }
  
  #mobile-theme-toggle .moon-icon {
    display: block;
  }
  
  :global(.dark) #mobile-theme-toggle .sun-icon {
    display: block;
  }
  
  :global(.dark) #mobile-theme-toggle .moon-icon {
    display: none;
  }
  
  :global(.dark) .header-logo {
    filter: brightness(0) invert(1);
  }
  
  .header-main nav a {
    color: var(--text-secondary);
    transition: color 0.2s;
  }
  
  .header-main nav a:hover {
    color: var(--text-primary);
  }
  
  /* Dropdown styling */
  .dropdown-container {
    position: relative;
  }
  
  .dropdown-trigger {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--text-secondary);
    transition: color 0.2s;
    padding: 1rem 0;
    outline: none;
    background: none;
    border: none;
    cursor: pointer;
  }
  
  .dropdown-trigger:hover {
    color: var(--text-primary);
  }

  .nav-link {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    border-radius: 0.75rem;
    transition: all 0.2s;
    font-weight: 500;
    text-decoration: none;
    background: transparent;
    border: none;
    cursor: pointer;
    outline: none;
  }

  .nav-link:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  
  .dropdown-chevron {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--text-tertiary);
    transition: transform 0.2s, color 0.2s;
  }
  
  .dropdown-container:hover .dropdown-chevron {
    transform: rotate(180deg);
    color: var(--text-primary);
  }
  
  .dropdown-menu {
    position: absolute;
    left: 0;
    top: 100%;
    padding-top: 0.25rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    transform: translateY(-0.5rem);
    min-width: 220px;
    z-index: 50;
    pointer-events: none;
  }
  
  .dropdown-container:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }
  
  .dropdown-content {
    background: var(--bg-primary);
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-primary);
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }
  
  .dropdown-item {
    display: flex;
    align-items: center;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    border-radius: 0.75rem;
    transition: all 0.2s;
    font-weight: 500;
    text-decoration: none;
  }
  
  .dropdown-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }
</style>

<script>
  import { toggleTheme } from '../scripts/theme';
  
  function initMobileThemeToggle() {
    const mobileThemeBtn = document.getElementById('mobile-theme-toggle');
    if (mobileThemeBtn) {
      // Remove old listener by cloning
      const newBtn = mobileThemeBtn.cloneNode(true);
      mobileThemeBtn.parentNode?.replaceChild(newBtn, mobileThemeBtn);
      
      const btn = document.getElementById('mobile-theme-toggle');
      if (btn) {
        btn.addEventListener('click', () => {
          toggleTheme();
        });
      }
    }
  }
  
  initMobileThemeToggle();
  document.addEventListener('astro:page-load', initMobileThemeToggle);
</script>
