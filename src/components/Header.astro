---
import Search from "./Search.astro";
import ThemeToggle from "./ThemeToggle.astro";
import { SUPPORTED_LOCALES, LOCALE_NAMES } from '../data/locales';
import { getUIStrings } from '../locales/ui-strings';

interface Props {
  currentLocale?: string;
  currentSlug?: string;
}

const { currentLocale, currentSlug } = Astro.props;

const base = import.meta.env.BASE_URL.replace(/\/+$/, '');

// Compute cross-locale URLs
function getLocaleUrl(targetLocale: string | null): string {
  if (!currentSlug) return targetLocale ? `${base}/${targetLocale}/` : `${base}/`;
  if (targetLocale) {
    return `${base}/${targetLocale}/${currentSlug}`.replace(/\/+/g, '/');
  }
  // English — strip the locale prefix if present
  return `${base}/${currentSlug}`.replace(/\/+/g, '/');
}

const ht = getUIStrings(currentLocale).header;

// Prefix an internal /docs/... path with the current locale (for initial server render)
function localizeHref(path: string): string {
  if (!currentLocale) return path;
  return path.replace(/^(\/docs\/)/, `$1${currentLocale}/`);
}

const docsHomePath = import.meta.env.BASE_URL; // "/docs/"
const serverApiPath = `${base}/getting-started-with-server-side-api`;
const sdkItems = [
  { label: "iOS",                  path: `${base}/ios-sdk-overview` },
  { label: "Android",              path: `${base}/android-sdk-overview` },
  { label: "React Native",         path: `${base}/react-native-sdk-overview` },
  { label: "Flutter",              path: `${base}/flutter-sdk-overview` },
  { label: "Unity",                path: `${base}/unity-sdk-overview` },
  { label: "Kotlin Multiplatform", path: `${base}/kmp-sdk-overview` },
  { label: "Capacitor",            path: `${base}/capacitor-sdk-overview` },
];

const englishUrl = getLocaleUrl(null);
const localeLinks = SUPPORTED_LOCALES.map(locale => ({
  locale,
  label: LOCALE_NAMES[locale],
  href: getLocaleUrl(locale),
  active: currentLocale === locale,
}));
---

<header class="header-main" transition:persist>
  <div class="w-full px-8 h-16 flex items-center justify-between">
    
    <div class="flex items-center gap-12">
        <!-- Logo -->
        <a href={import.meta.env.BASE_URL.replace(/\/+$/, '') || '/'} class="flex-shrink-0 block hover:opacity-80 transition-opacity">
          <img src={`${import.meta.env.BASE_URL}/logo.svg`.replace(/\/+/g, '/')} alt="Adapty" class="h-6 w-auto header-logo" />
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden lg:flex items-center gap-1 text-[14px] font-medium">
          <a href={localizeHref(docsHomePath)} data-nav-href={docsHomePath} class="nav-link" data-i18n="documentation">{ht.documentation}</a>

          <!-- Mobile SDK Dropdown -->
          <div class="relative dropdown-container">
            <button class="dropdown-trigger nav-link">
              <span data-i18n="mobileSdk">{ht.mobileSdk}</span>
              <svg class="dropdown-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            
            <!-- Dropdown Menu -->
            <div class="dropdown-menu">
               <div class="dropdown-content">
                {sdkItems.map(item => (
                  <a
                    href={localizeHref(item.path).replace(/\/+/g, '/')}
                    data-nav-href={item.path.replace(/\/+/g, '/')}
                    class="dropdown-item"
                  >
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
          </div>

          <a href={localizeHref(serverApiPath).replace(/\/+/g, '/')} data-nav-href={serverApiPath.replace(/\/+/g, '/')} class="nav-link" data-i18n="serverApi">{ht.serverApi}</a>
          <a href="https://adapty.io/docs/whats-new" class="nav-link" data-i18n="whatsNew">{ht.whatsNew}</a>
          <a href="https://adapty.featurebase.app" class="nav-link" data-i18n="supportForum">{ht.supportForum}</a>
        </nav>
    </div>

    <!-- Search (Desktop) -->
    <div class="hidden lg:flex flex-1 max-w-sm mx-8">
      <Search currentLocale={currentLocale} />
    </div>

    <!-- Auth Buttons & Theme Toggle -->
    <div class="hidden lg:flex items-center gap-3">
      <ThemeToggle />

      <!-- Language Switcher -->
      <div class="lang-switcher relative dropdown-container">
        <button class="lang-trigger nav-link" aria-label="Switch language">
          <span id="lang-label">{currentLocale ? LOCALE_NAMES[currentLocale as keyof typeof LOCALE_NAMES] ?? currentLocale : 'EN'}</span>
          <svg class="dropdown-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="dropdown-menu lang-menu">
          <div class="dropdown-content">
            <a
              href={englishUrl}
              class:list={["dropdown-item", !currentLocale ? "lang-active" : ""]}
              data-locale=""
            >English</a>
            {localeLinks.map(({ locale, label, href, active }) => (
              <a
                href={href}
                class:list={["dropdown-item", active ? "lang-active" : ""]}
                data-locale={locale}
              >{label}</a>
            ))}
          </div>
        </div>
      </div>

      <a href="https://app.adapty.io/login" class="nav-link" data-i18n="signIn">{ht.signIn}</a>
      <a
        href="https://app.adapty.io/registration"
        class="px-5 py-2.5 text-sm font-semibold text-white bg-[#6720ff] hover:bg-[#5816e8] dark:bg-purple-600 dark:hover:bg-purple-500 rounded-xl transition-all shadow-[0_4px_15px_-2px_rgba(103,32,255,0.3)] hover:shadow-[0_8px_25px_-5px_rgba(103,32,255,0.4)] active:scale-[0.98]"
        data-i18n="signUpFree"
      >{ht.signUpFree}</a>
    </div>

    <!-- Mobile Search, Theme & Menu Buttons -->
    <div class="lg:hidden flex items-center gap-1">
      <button id="mobile-search-btn" class="p-2 text-[#443f49] dark:text-slate-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
      
      <button id="mobile-theme-toggle" type="button" class="mobile-theme-toggle p-2" aria-label="Toggle theme" title="Toggle theme">
        <!-- Sun icon (visible in dark mode) -->
        <svg class="sun-icon w-5 h-5" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        
        <!-- Moon icon (visible in light mode) -->
        <svg class="moon-icon w-5 h-5" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      
      <button id="mobile-menu-btn" class="p-2 text-[#443f49] dark:text-slate-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
  </div>
</header>

<style>
  .header-main {
    position: sticky;
    top: 0;
    z-index: 70;
    width: 100%;
    height: 64px;
    box-sizing: border-box;
    background-color: var(--bg-primary);
    backdrop-filter: blur(12px);
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
  }
  
  #mobile-menu-btn,
  #mobile-search-btn,
  #mobile-theme-toggle {
    position: relative;
    z-index: 71;
    cursor: pointer;
    transition: color 0.2s;
  }
  
  #mobile-search-btn:hover,
  #mobile-menu-btn:hover,
  #mobile-theme-toggle:hover {
    color: var(--text-primary);
  }
  
  /* Mobile theme toggle icons */
  #mobile-theme-toggle {
    border: none;
    background: transparent;
    color: var(--text-secondary);
  }
  
  #mobile-theme-toggle .sun-icon {
    display: none;
  }
  
  #mobile-theme-toggle .moon-icon {
    display: block;
  }
  
  :global(.dark) #mobile-theme-toggle .sun-icon {
    display: block;
  }
  
  :global(.dark) #mobile-theme-toggle .moon-icon {
    display: none;
  }
  
  :global(.dark) .header-logo {
    filter: brightness(0) invert(1);
  }
  
  .header-main nav a {
    color: var(--text-secondary);
    transition: color 0.2s;
  }
  
  .header-main nav a:hover {
    color: var(--text-primary);
  }
  
  /* Dropdown styling */
  .dropdown-container {
    position: relative;
  }
  
  .dropdown-trigger {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--text-secondary);
    transition: color 0.2s;
    padding: 1rem 0;
    outline: none;
    background: none;
    border: none;
    cursor: pointer;
  }
  
  .dropdown-trigger:hover {
    color: var(--text-primary);
  }

  .nav-link {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    border-radius: 0.75rem;
    transition: all 0.2s;
    font-weight: 500;
    text-decoration: none;
    background: transparent;
    border: none;
    cursor: pointer;
    outline: none;
  }

  .nav-link:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  
  .dropdown-chevron {
    width: 0.875rem;
    height: 0.875rem;
    color: var(--text-tertiary);
    transition: transform 0.2s, color 0.2s;
  }
  
  .dropdown-container:hover .dropdown-chevron {
    transform: rotate(180deg);
    color: var(--text-primary);
  }
  
  .dropdown-menu {
    position: absolute;
    left: 0;
    top: 100%;
    padding-top: 0.25rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    transform: translateY(-0.5rem);
    min-width: 220px;
    z-index: 50;
    pointer-events: none;
  }
  
  .dropdown-container:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }
  
  .dropdown-content {
    background: var(--bg-primary);
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-primary);
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }
  
  .dropdown-item {
    display: flex;
    align-items: center;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    border-radius: 0.75rem;
    transition: all 0.2s;
    font-weight: 500;
    text-decoration: none;
  }
  
  .dropdown-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  .lang-active {
    color: var(--accent-primary);
    font-weight: 600;
  }

  .lang-trigger {
    gap: 0.375rem;
    font-size: 0.8125rem;
    min-width: 2.5rem;
  }
</style>

<script>
  import { toggleTheme } from '../scripts/theme';
  
  function initMobileThemeToggle() {
    const mobileThemeBtn = document.getElementById('mobile-theme-toggle');
    if (mobileThemeBtn) {
      // Remove old listener by cloning
      const newBtn = mobileThemeBtn.cloneNode(true);
      mobileThemeBtn.parentNode?.replaceChild(newBtn, mobileThemeBtn);
      
      const btn = document.getElementById('mobile-theme-toggle');
      if (btn) {
        btn.addEventListener('click', () => {
          toggleTheme();
        });
      }
    }
  }
  
  initMobileThemeToggle();
  document.addEventListener('astro:page-load', initMobileThemeToggle);

  // Locale names map for client-side use
  const LOCALE_NAMES_CLIENT: Record<string, string> = { zh: '中文' };

  // UI string translations for client-side sync (mirrors src/locales/ui-strings.ts)
  const UI_STRINGS_CLIENT: Record<string, Record<string, string>> = {
    zh: {
      documentation: '文档',
      mobileSdk: '移动端 SDK',
      serverApi: '服务端 API',
      whatsNew: '最新动态',
      supportForum: '支持论坛',
      signIn: '登录',
      signUpFree: '免费注册',
      searchPlaceholder: '搜索文档...',
      searchNoResults: '未找到相关结果。',
    },
    en: {
      documentation: 'Documentation',
      mobileSdk: 'Mobile SDK',
      serverApi: 'Server API',
      whatsNew: "What's new",
      supportForum: 'Support Forum',
      signIn: 'Sign In',
      signUpFree: 'Sign Up for Free',
      searchPlaceholder: 'Search documentation...',
      searchNoResults: 'No results found.',
    },
  };

  // Rewrite internal nav link hrefs to include (or strip) the current locale prefix
  function syncNavLinks() {
    const localeMatch = window.location.pathname.match(/\/docs\/([a-z]{2})(\/|$)/);
    const locale = localeMatch ? localeMatch[1] : null;

    document.querySelectorAll<HTMLAnchorElement>('[data-nav-href]').forEach(el => {
      const basePath = el.getAttribute('data-nav-href')!;
      el.href = locale
        ? basePath.replace(/^(\/docs\/)/, `$1${locale}/`)
        : basePath;
    });
  }

  // Update nav text content based on current locale in URL
  function syncHeaderI18n() {
    const localeMatch = window.location.pathname.match(/\/docs\/([a-z]{2})\//);
    const locale = localeMatch ? localeMatch[1] : 'en';
    const strings = UI_STRINGS_CLIENT[locale] ?? UI_STRINGS_CLIENT.en;

    document.querySelectorAll<HTMLElement>('[data-i18n]').forEach(el => {
      const key = el.dataset.i18n!;
      if (strings[key]) el.textContent = strings[key];
    });

    document.querySelectorAll<HTMLInputElement>('[data-i18n-placeholder]').forEach(el => {
      const key = el.dataset.i18nPlaceholder!;
      if (strings[key]) el.placeholder = strings[key];
    });

    // Sync search Algolia index to the current locale.
    // The header is transition:persist so data-index-name would otherwise stay
    // at the value baked in at initial page render.
    const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
    if (searchInput) {
      const localeKey = `indexName${locale.charAt(0).toUpperCase() + locale.slice(1)}`;
      const localeIndex = (searchInput.dataset as Record<string, string>)[localeKey];
      const defaultIndex = searchInput.dataset.indexNameDefault ?? '';
      searchInput.dataset.indexName = localeIndex || defaultIndex;
    }

    // Sync "no results" text on the search results container.
    const searchResultsEl = document.getElementById('search-results');
    if (searchResultsEl && strings['searchNoResults']) {
      searchResultsEl.dataset.noResults = strings['searchNoResults'];
    }
  }

  // Sync lang switcher label, active state, and hrefs based on current URL.
  // Needed because the header is transition:persist and doesn't re-render on navigation.
  function syncLangSwitcher() {
    const path = window.location.pathname;
    // Match /docs/zh/ — capture the base prefix and the locale code
    const localeMatch = path.match(/^(.*\/docs\/)([a-z]{2})\//);
    const currentLocale = localeMatch ? localeMatch[2] : null;
    // Path without the locale prefix (the English equivalent)
    const englishPath = localeMatch
      ? path.replace(`${localeMatch[1]}${localeMatch[2]}/`, localeMatch[1])
      : path;

    // Update button label
    const labelEl = document.getElementById('lang-label');
    if (labelEl) {
      labelEl.textContent = currentLocale ? (LOCALE_NAMES_CLIENT[currentLocale] ?? currentLocale) : 'EN';
    }

    // Update link hrefs and active classes
    document.querySelectorAll<HTMLAnchorElement>('[data-locale]').forEach(el => {
      const locale = el.dataset.locale ?? '';
      const isActive = locale === (currentLocale ?? '');
      el.classList.toggle('lang-active', isActive);

      // Recompute href to match current page
      if (locale === '') {
        el.href = englishPath;
      } else {
        el.href = localeMatch
          ? path.replace(`${localeMatch[1]}${localeMatch[2]}/`, `${localeMatch[1]}${locale}/`)
          : path.replace(/^(.*\/docs\/)/, `$1${locale}/`);
      }
    });
  }

  // Save preferred locale when user clicks a language switcher link
  function initLangSwitcher() {
    syncLangSwitcher();
    syncHeaderI18n();
    syncNavLinks();
    document.querySelectorAll('[data-locale]').forEach(el => {
      el.addEventListener('click', () => {
        const locale = (el as HTMLElement).dataset.locale;
        if (locale) {
          localStorage.setItem('preferred-locale', locale);
        } else {
          localStorage.removeItem('preferred-locale');
        }
      });
    });
  }
  initLangSwitcher();
  document.addEventListener('astro:page-load', initLangSwitcher);
</script>
